---
title: "Predicting Train Arrival Status - On Time or Late"
author: "Adanna Alutu"
date: "June 6, 2017"
output: html_document

---

#Introduction

At the beginning of the project, it was hard to come up with a good data to analyze and try to predict the outcome. Initially I wanted to work on data from my job but after we coudn't see much dependence among the fields that made sense, my mentor Dr. Shmuel Naaman advised me to scout for data from other internet sites he recommended.

Since I take the train most of the time and experienced delay issues some weeks, I wanted to work on transportation data for trains. My mentor agreed with me and the Septa Train data from kaggle website was a good option to work on. There were 3 different datasets to work on but chose the "on time performance" which I felt was more relevant to what needed to be achieved based on the variables and observations provided.

The variables in the dataset include:
1. train_id
2. status
3. origin
4. direction
5. next_station
6. timeStamp
7. date

Preparing data for analysis:

Several steps were taken to be able to combine the variables so we could come up with a meaningful interpretation and predition.

A. First used GGPlot to be able to see the trend and use the statistics and summary but the graph was too blurry and too small to be able to come up with anything meaningful.

B. My mentor suggested shuffling the data and taking the first 20percent as sample to work on.

C. We used the data to fit in several models which include:
    + GGPlot with different combination of the variables.
    + Linear regression model which was used different ways to get the best stastical summary. Including using some of the observations as variables.
    + CART model with focus on the classification method because most of the variables in the data are categorical and the prediction is binary with 0 as "on Time" and 1 as "Late"

#This section shows the summary of the SEPTA train data and the first few records using the head().

```{r, echo=FALSE}

library(tidyr)
library(lubridate)

train_data <- read.csv("C:/Users/aalutu/Desktop/work/pers/data science/on-time-performance/trainsample_otp.csv")
train_data$datets <- as.POSIXct(train_data$timeStamp, format = "%m/%d/%Y %H:%M")
head(train_data$datets)
train_data$wkday <-weekdays(as.Date(train_data$date, format = "%m/%d/%Y"))
head(train_data$wkday)
train_data$month <-month(as.Date(train_data$date, "%m/%d/%Y"))
head(train_data$month)

train_data <- separate(train_data, datets, c("date3","time"), sep = " ")
head(train_data)
train_data <- separate(train_data, time, c("hour","minute"), sep = ":")
head(train_data)

train_data <- separate(train_data, date3, c("date3yr","d3month", "monthday"), sep = "-")
head(train_data)

train_data$monthday

#remove the date column
train_data$date <- NULL
train_data$date3yr <- NULL
train_data$d3month <- NULL
train_data$timeStamp <- NULL

head(train_data)

train_data$status <- gsub(pattern="min", replacement = "", x = train_data$status, ignore.case = TRUE)
head(train_data$status)
#variable for the cartmodel
#traincartstatus <- train_data$status
#end variable for cartmodel

train_data$status <- gsub(pattern="On Time", replacement = "0", x = train_data$status, ignore.case = TRUE)


head(train_data)
summary(train_data)

```

#GGplot graphs used initally to see trends and relationships within the datasets.
```{r}

library("ggplot2")
trainid_graph <- ggplot(train_data, aes(x = train_data$train_id)) +
  geom_bar() +
   theme(axis.text.x = element_text(angle=90, hjust=1))

trainid_graph

```


```{r}

origin_chart <- ggplot(train_data, aes(x = train_data$origin)) +
  geom_bar() +
   theme(axis.text.x = element_text(angle=90, hjust=1))

 origin_chart
```



#Add the weekday variables as column to train_data dataframe.
```{r}
#Added contrasts to print all travel days and all days of the months otherwise some are skipped.

train_data <- cbind(train_data, as.data.frame(model.matrix(~ wkday + monthday, data = train_data, contrasts.arg = list(wkday = contr.treatment(n = 7, contrasts = FALSE), monthday = contr.treatment(n = 31, contrasts = FALSE)))))


head(train_data)
##cbind for only train_data and converting wkday to variable
#train_data <- cbind(train_data, as.data.frame(model.matrix( ~ wkday, data = train_data)))
#head(train_data)
#summary(train_data)
```

#Linear model statistical summary for Status based on x = origin:

```{r}

train_data$monthday <- as.numeric(train_data$monthday)
#head(traindata5col)
#summary(traindata5col)


##linear model of each graph
library(broom)

summary(lm(log(as.numeric( train_data$status)+1) ~ origin, data = train_data))

```


#Origin + weekday

```{r}

summary(lm(log(as.numeric( train_data$status)+1) ~ origin + wkday, data = train_data))

```
```{r}

```
#Origin + hour+ monthday + wkday

```{r}

glance(summary(lm(log(as.numeric( train_data$status)+1) ~ origin + hour, data = train_data)))

glance(summary(lm(log(as.numeric( train_data$status)+1) ~ origin + hour + wkday + monthday, data = train_data)))

```




```{r}
summary(lm(log(as.numeric( train_data$status)+1) ~ origin+ hour + month + monthday + wkday1 + wkday2 + wkday3 + wkday4 + wkday5, data = train_data))

```



#Next is the linear model chat which was used to get better stats. Involved adding most of the independent variables to the linear model.
```{r}

glance(summary(lm(log(as.numeric( train_data$status)+1) ~ origin+ hour + minute + month + wkday1 + wkday2 + wkday3 + wkday4 + wkday5 + wkday6 + wkday7 + monthday1 + monthday2 + monthday3 + monthday4 + monthday5 + monthday6 + monthday7 + monthday8 + monthday9 + monthday10 + monthday11 + monthday12 + monthday13 + monthday14+ monthday15 + monthday16 + monthday17 + monthday18 + monthday19 + monthday20 + monthday21+ monthday22 + monthday23 + monthday24 + monthday25 + monthday26 + monthday27 + monthday28+ monthday29 + monthday30 + monthday31 + train_data$next_station + train_data$direction, data = train_data)))

```

#Add the CART model. Staus is the output or dependent variable since we need to know if it's on time (0 observation) or late (1 in the observations). Used a classification method since the status variable is binary.
```{r}

#convert the dependent or output variable "status" observations to either 0 or 1 so the
#classification CART method can be used.


train_data$status <- replace(train_data$status, train_data$status > 0, 1)
head(train_data$status)
head(train_data)

library(caTools)
set.seed(1)

#create split
split = sample.split(train_data$status, SplitRatio = 0.8)

#create training and test set using the subset function

Trainset = subset(train_data, split==TRUE)
Testset = subset(train_data, split == FALSE)

#built CART model

library(rpart)
library(rpart.plot)

#now create the CART model
TraindataTree = rpart(status ~ origin+ hour + minute + month + train_data$next_station + train_data$direction, data = train_data, method = "class", control = rpart.control(minbucket = 25))

#plot the tree

prp(TraindataTree)

```


#to see how the CART model will predict the TEST subset (20% of the data).

```{r}
##predict 
#predictstatusCART = predict(TraindataTree, newdata = Testset, type = "class")

#table(Testset$status, predictstatusCART)

```

